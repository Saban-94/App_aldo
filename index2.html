<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>דשבורד ראשי - ח.סבן</title>
    <meta name="theme-color" content="#0b72b9"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    <link rel="icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --brand: #0b72b9; --accent: #ff9f1c; --bg: #f0f2f5; --card: #ffffff;
            --text-dark: #1a202c; --text-light: #4a5568; --text-muted: #718096;
            --border: #e2e8f0; --success: #38a169; --warning: #dd6b20; --danger: #e53e3e;
            --radius: 16px; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --status-new: #a0aec0; --status-processing: #4299e1; --status-shipped: #ed8936; 
            --status-delivered: #38a169; --status-cancelled: #e53e3e;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes statusPulse { 0% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.5); } 70% { box-shadow: 0 0 0 10px rgba(66, 153, 225, 0); } 100% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0); } }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg); }
        body { font-family: 'Assistant', sans-serif; color: var(--text-dark); display: flex; flex-direction: column; overscroll-behavior-y: contain; }
        .app-shell { display: flex; flex-direction: column; height: 100%; }
        .app-header { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background-color: var(--card); border-bottom: 1px solid var(--border); position: relative; z-index: 10; }
        .app-container { flex-grow: 1; overflow-y: auto; padding: 20px 15px 100px 15px; }
        
        .page-title { font-size: 28px; font-weight: 700; margin-bottom: 20px; animation: fadeIn 0.5s ease-out forwards; }
        .card { background-color: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border); animation: popIn 0.5s ease-out forwards; overflow: hidden; }
        .btn { background: var(--brand); color: white; border: none; padding: 12px 18px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 15px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; width: 100%; }
        .btn:active { transform: scale(0.95); }
        .btn.secondary { background-color: var(--bg); color: var(--text-dark); border: 1px solid var(--border); }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .dashboard-card { background: var(--card); border-radius: var(--radius); padding: 15px; text-align: center; box-shadow: var(--shadow); transition: transform 0.2s, box-shadow 0.2s; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .dashboard-value { font-size: 24px; font-weight: 700; margin: 5px 0; }
        .dashboard-label { font-size: 14px; color: var(--text-muted); }
        
        .mini-map-container { border-radius: 12px; border: 1px solid var(--border); height: 150px; width: 100%; margin-top: 15px; background-color: #eee; }
        .leaflet-control-zoom, .leaflet-control-attribution { display: none !important; }
        .profile-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border); }
        
        .status-cube { width: 20px; height: 20px; border-radius: 4px; display: inline-block; margin-left: 8px; animation: statusPulse 2s infinite; }
        .status-new { background-color: var(--status-new); }
        .status-processing { background-color: var(--status-processing); }
        .status-shipped { background-color: var(--status-shipped); }
        .status-delivered { background-color: var(--status-delivered); }
        .status-cancelled { background-color: var(--status-cancelled); }
        
        .order-status { display: flex; align-items: center; gap: 10px; margin: 10px 0; padding: 10px; border-radius: var(--radius); background-color: var(--bg); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background-color: var(--card); display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--text-muted); text-decoration: none; font-weight: 600; font-size: 14px; border: none; background: transparent; cursor: pointer; transition: color 0.2s, transform 0.2s;}
        .nav-btn.active { color: var(--brand); }
        .nav-btn svg { width: 28px; height: 28px; pointer-events: none; }
        
        #toast-container { position: fixed; top: 20px; left: 15px; right: 15px; z-index: 4000; display: flex; flex-direction: column; gap: 10px; align-items: center;}
        .toast { display: flex; align-items: center; gap: 12px; width: 100%; max-width: 400px; background: var(--card); color: var(--text-dark); padding: 14px 22px; border-radius: var(--radius); font-weight: 600; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 1px solid var(--border); opacity: 0; transform: translateY(-20px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 25px; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; animation: popIn 0.3s; }
        
        #splash-screen { position: fixed; inset: 0; z-index: 9999; background-color: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease, visibility 0.5s ease; }
        #splash-logo { width: 120px; }
        .splash-loader { width: 40px; height: 40px; border: 4px solid rgba(11, 114, 185, 0.2); border-top-color: var(--brand); border-radius: 50%; animation: spin 1s linear infinite; margin-top: 20px; opacity: 0; transition: opacity 0.3s; }
        #splash-screen.loading .splash-loader { opacity: 1; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .quick-action-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--card); border-radius: var(--radius); padding: 20px 10px; text-align: center; box-shadow: var(--shadow); transition: all 0.2s; border: 1px solid var(--border); text-decoration: none; color: inherit; }
        .quick-action-btn:active { transform: scale(0.95); }
        .quick-action-btn svg { width: 40px; height: 40px; margin-bottom: 10px; color: var(--brand); }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="app-header">
            <div id="profile-container" class="profile-container">
                <img id="profile-avatar" src="" alt="Profile" class="profile-avatar">
            </div>
             <h1 id="client-name-header" style="font-weight: 700; font-size: 16px;">...</h1>
            <div style="text-align: center; font-weight: 600;">
                <div id="clock"></div>
                <div id="date" style="font-size: 12px; color: var(--text-muted);"></div>
            </div>
        </header>

        <main class="app-container" id="app-container">
            <h1 class="page-title" id="greeting"></h1>
            
            <!-- Dashboard -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="dashboard-value" id="active-containers">0</div>
                    <div class="dashboard-label">מכולות פעילות</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-value" id="pending-orders">0</div>
                    <div class="dashboard-label">הזמנות ממתינות</div>
                </div>
            </div>
            
            <!-- Active Orders -->
            <div class="card">
                <h2 style="margin-bottom: 15px;">הזמנות פעילות</h2>
                <div id="active-orders-container">
                    <p class="text-gray-500">טוען הזמנות...</p>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <h2 style="margin-bottom: 15px;">פעולות מהירות</h2>
                <div class="quick-actions">
                    <a id="materials-link" href="#" class="quick-action-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                        </svg>
                        <span>חומרי בנין</span>
                    </a>
                    <a id="containers-link" href="#" class="quick-action-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 11V5a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5"></path>
                            <path d="M20 7h-5a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h5a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path>
                        </svg>
                        <span>מכולות</span>
                    </a>
                </div>
            </div>
            
            <!-- Order Location Map -->
            <div class="card">
                <h2 style="margin-bottom: 15px;">מיקום הזמנות פעילות</h2>
                <div id="map" class="mini-map-container"></div>
            </div>
            
            <!-- Recent Orders -->
            <div class="card">
                <h2 style="margin-bottom: 15px;">הזמנות אחרונות</h2>
                <div id="recent-orders-list" class="space-y-2">
                    <p class="text-gray-500">טוען הזמנות...</p>
                </div>
            </div>
        </main>
    </div>
    
    <nav class="bottom-nav">
        <button class="nav-btn active" data-action="navigate" data-page="page-home">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span>דף הבית</span>
        </button>
        <button class="nav-btn" data-action="navigate" data-page="page-materials">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            <span>חומרי בנין</span>
        </button>
        <button class="nav-btn" data-action="navigate" data-page="page-history">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
            <span>היסטוריה</span>
        </button>
    </nav>
    
    <div id="splash-screen"><img id="splash-logo" src="https://i.postimg.cc/2SbDgD1B/1.png" alt="לוגו ח.סבן"><div class="splash-loader"></div></div>
    <div id="toast-container"></div>
    <div id="modal-container" class="modal-overlay"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, setDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDy3k1AoEKeuCKjmFxefn9fapeqv2Le1_w",
            authDomain: "hsaban94-cc777.firebaseapp.com",
            projectId: "hsaban94-cc777",
            storageBucket: "hsaban94-cc777.appspot.com",
            messagingSenderId: "299206369469",
            appId: "1:299206369469:web:50ca90c58f1981ec9457d4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const messaging = getMessaging(app);

        // Main Application Logic
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = "https://script.google.com/macros/s/AKfycbz5zkASUR1Ye1ZzYvPDvq4VhZegvZHzG5vdczLEaahcw_NDO2D9vb_4sGVYFrjrHzc/exec";
            
            let clientState = { 
                id: null, 
                name: null, 
                avatar: null, 
                orders: []
            };
            
            const dom = {};

            function initApp() {
                cacheDomElements();
                updateClock();
                setInterval(updateClock, 1000);
                
                // Check authentication
                checkAuthentication();
            }
            
            function cacheDomElements(){
                Object.assign(dom, {
                    appShell: document.querySelector('.app-shell'),
                    splashScreen: document.getElementById('splash-screen'),
                    modalContainer: document.getElementById('modal-container'),
                    toastContainer: document.getElementById('toast-container'),
                    activeOrdersContainer: document.getElementById('active-orders-container'),
                    greeting: document.getElementById('greeting'),
                    clientNameHeader: document.getElementById('client-name-header'),
                    profileAvatar: document.getElementById('profile-avatar'),
                    clock: document.getElementById('clock'),
                    date: document.getElementById('date'),
                    recentOrdersList: document.getElementById('recent-orders-list'),
                    activeContainers: document.getElementById('active-containers'),
                    pendingOrders: document.getElementById('pending-orders'),
                    materialsLink: document.getElementById('materials-link'),
                    containersLink: document.getElementById('containers-link'),
                    navButtons: document.querySelectorAll('.nav-btn')
                });
            }
            
            function checkAuthentication() {
                console.log("--- דשבורד: מתחיל בדיקת אימות ---");

                const urlParams = new URLSearchParams(window.location.search);
                const customerIdFromUrl = urlParams.get('customerId');
                console.log("שלב 1: מספר לקוח מכתובת האתר:", customerIdFromUrl);
                
                const loggedInUserString = sessionStorage.getItem('loggedInUser');
                console.log("שלב 2: מידע גולמי מזיכרון הדפדפן:", loggedInUserString);

                if (!loggedInUserString) {
                    console.error("שגיאת אימות: לא נמצא מידע בזיכרון הדפדפן. מבצע הפניה לדף התחברות.");
                    window.location.href = './login.html';
                    return;
                }

                const loggedInUser = JSON.parse(loggedInUserString);
                console.log("שלב 3: אובייקט המשתמש שפוענח:", loggedInUser);

                const customerIdFromSession = loggedInUser['מספר לקוח'];
                console.log("שלב 4: מספר לקוח שחולץ מאובייקט המשתמש:", customerIdFromSession);

                const finalIdFromUrl = String(customerIdFromUrl || '').trim();
                const finalIdFromSession = String(customerIdFromSession || '').trim();

                console.log(`שלב 5: מבצע השוואה: האם "${finalIdFromUrl}" (מהכתובת) זהה ל-"${finalIdFromSession}" (מהזיכרון)?`);

                if (finalIdFromUrl === '' || finalIdFromSession === '' || finalIdFromUrl !== finalIdFromSession) {
                    console.error("שגיאת אימות: מספרי הלקוח אינם זהים! מבצע הפניה לדף התחברות.");
                    window.location.href = './login.html';
                    return;
                }

                console.log("אימות עבר בהצלחה! טוען את הדשבורד.");

                // If we reached here, the user is authorized. Continue loading the page.
                dom.clientNameHeader.textContent = loggedInUser['שם לקוח'];
                dom.greeting.textContent = `שלום, ${loggedInUser['שם לקוח']}`;
                dom.materialsLink.href = `./Materials.html?customerId=${customerIdFromUrl}`;
                dom.containersLink.href = `./containers.html?customerId=${customerIdFromUrl}`;
                
                // Set client state
                clientState = {
                    ...clientState,
                    id: customerIdFromSession,
                    name: loggedInUser['שם לקוח']
                };
                
                // Load client data
                loadClientData(customerIdFromSession);
            }
            
            async function loadClientData(clientId) {
                try {
                    const data = await apiPost(API_URL, { action: 'getClientData', identifier: clientId });
                    if (data.status === 'error' || !data.clientName) throw new Error(data.message || "Client not found");
                    
                    clientState = { 
                        ...clientState, 
                        id: data.clientId, 
                        name: data.clientName, 
                        avatar: data.avatarUrl, 
                        orders: data.orders || [] 
                    };
                    
                    await requestNotificationPermission();
                    setupNotificationsListener();
                    setupOrdersListener();

                    // Hide splash screen and show content
                    dom.splashScreen.style.opacity = '0';
                    setTimeout(() => {
                        dom.splashScreen.style.display = 'none';
                    }, 500);
                    
                    renderDashboard();
                    setupEventListeners();

                } catch (error) {
                    console.error("Failed to load client data:", error);
                    showToast("שגיאה בטעינת נתונים.", '❌');
                }
            }
            
            async function apiPost(url, body) {
                const response = await fetch(url, { method: 'POST', body: JSON.stringify(body) });
                if (!response.ok) throw new Error('Network error');
                return response.json();
            }

            function updateClock() {
                const now = new Date();
                // Convert to Israel timezone
                const options = { timeZone: 'Asia/Jerusalem', hour: '2-digit', minute: '2-digit' };
                dom.clock.textContent = now.toLocaleTimeString('he-IL', options);
                
                const dateOptions = { timeZone: 'Asia/Jerusalem', weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                dom.date.textContent = now.toLocaleDateString('he-IL', dateOptions);
            }
            
            function renderDashboard() {
                renderActiveOrders();
                renderRecentOrders();
                updateDashboard();
                initMap();
            }
            
            function renderActiveOrders() {
                const activeOrders = clientState.orders.filter(o => o['סטטוס'] !== 'סגור');
                const container = dom.activeOrdersContainer;
                container.innerHTML = '';
                
                if (activeOrders.length > 0) {
                    activeOrders.forEach(order => {
                        const cardElement = createOrderCardElement(order);
                        container.appendChild(cardElement);
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500">אין לך כרגע הזמנות פעילות.</p>';
                }
            }
            
            function renderRecentOrders() {
                const recentOrders = clientState.orders.slice(0, 5); // Show last 5 orders
                const listEl = dom.recentOrdersList;
                
                if (recentOrders.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500">אין הזמנות אחרונות להצגה.</p>';
                    return;
                }
                
                listEl.innerHTML = recentOrders.map(order => `
                    <div class="order-item" style="padding: 10px; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${formatDate(order['תאריך הזמנה'])}</strong>
                                <div style="font-size: 14px; color: var(--text-muted);">${order['כתובת']}</div>
                            </div>
                            <div class="order-status">
                                <span class="status-cube status-${getStatusClass(order['סטטוס'])}"></span>
                                <span>${order['סטטוס']}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            function createOrderCardElement(order) {
                const card = document.createElement('div');
                card.className = 'order-card';
                card.style.padding = '15px';
                card.style.borderBottom = '1px solid var(--border)';
                card.innerHTML = `
                    <h3 style="margin-bottom: 10px;">${order['שם פרויקט'] || `הזמנה`}</h3>
                    <p style="margin-bottom: 10px;">${order['כתובת']}</p>
                    <div class="order-status">
                        <span>סטטוס:</span>
                        <span class="status-cube status-${getStatusClass(order['סטטוס'])}"></span>
                        <span>${order['סטטוס']}</span>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn secondary" data-action="request-swap" data-id="${order['תעודה']}" style="flex: 1; font-size: 14px; padding: 8px;">החלפה</button>
                        <button class="btn" data-action="request-pickup" data-id="${order['תעודה']}" style="flex: 1; font-size: 14px; padding: 8px;">פינוי</button>
                    </div>`;
                return card;
            }
            
            function initMap() {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) return;
                
                // Use the first active order's address for the map
                const activeOrders = clientState.orders.filter(o => o['סטטוס'] !== 'סגור');
                if (activeOrders.length > 0) {
                    const order = activeOrders[0];
                    renderLeafletMap(mapContainer, order['כתובת']);
                } else {
                    mapContainer.innerHTML = '<p style="text-align: center; padding: 60px 0;">אין הזמנות פעילות להצגה במפה</p>';
                }
            }
            
            function renderLeafletMap(container, address) {
                if (!container || !address) return;
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const { lat, lon } = data[0];
                            const map = L.map(container, { zoomControl: false }).setView([lat, lon], 15);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                            L.marker([lat, lon]).addTo(map);
                        } else { 
                            container.innerHTML = '<p style="text-align: center; padding: 60px 0;">כתובת לא נמצאה</p>'; 
                        }
                    }).catch(err => { 
                        container.innerHTML = '<p style="text-align: center; padding: 60px 0;">שגיאה בטעינת מפה</p>'; 
                    });
            }

            // --- NOTIFICATIONS AND STATUS UPDATES ---
            async function requestNotificationPermission() {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        console.log('Notification permission not granted');
                        return;
                    }
                    
                    const token = await getToken(messaging, { 
                        vapidKey: "BPkYpQ8Obf41BWjzMZD27tdpO8xCVQNwrTLznU-jjMb_S9i_y9XhRsdxE6ftEcmm0eJr6DoCM9JXh69dcGFio50" 
                    });
                    
                    if (token && clientState.id) {
                        await saveTokenToFirestore(token, clientState.id);
                    }
                } catch (error) {
                    console.error('Error getting notification token', error);
                }
            }
            
            async function saveTokenToFirestore(token, clientId) {
                try {
                    await setDoc(doc(db, 'clients', clientId), { 
                        fcmToken: token, 
                        lastUpdated: serverTimestamp() 
                    }, { merge: true });
                    console.log('FCM Token saved successfully');
                } catch (error) {
                    console.error('Error saving FCM token:', error);
                }
            }
            
            function setupNotificationsListener() {
                // Listen for FCM messages
                onMessage(messaging, (payload) => {
                    console.log('Message received:', payload);
                    showToast(payload.notification.body, '🔔');
                });
            }
            
            function setupOrdersListener() {
                if (!clientState.id) return;
                
                const ordersQuery = query(
                    collection(db, "clientOrders"), 
                    where("clientId", "==", clientState.id)
                );
                
                const unsubscribe = onSnapshot(ordersQuery, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "modified") {
                            const orderData = change.doc.data();
                            handleOrderStatusUpdate(orderData);
                        }
                    });
                    
                    updateDashboard();
                });
            }
            
            function handleOrderStatusUpdate(orderData) {
                const statusMessages = {
                    "new": "הזמנתך התקבלה וממתינה לאישור",
                    "processing": "הזמנתך נמצאת כעת בעיבוד",
                    "shipped": "הזמנתך יצאה למשלוח",
                    "delivered": "הזמנתך נמסרה",
                    "cancelled": "הזמנתך בוטלה"
                };
                
                if (statusMessages[orderData.status]) {
                    showToast(statusMessages[orderData.status], '📦');
                }
                
                // If order is shipped, show Waze link
                if (orderData.status === "shipped" && orderData.driverLocation) {
                    const wazeLink = `https://www.waze.com/ul?ll=${orderData.driverLocation.latitude}%2C${orderData.driverLocation.longitude}&navigate=yes`;
                    showToast(`הנהג בדרך! <a href="${wazeLink}" style="color: var(--brand); text-decoration: underline;" target="_blank">צפה במיקום ב-Waze</a>`, '🚗');
                }
            }
            
            function updateDashboard() {
                if (!clientState.id) return;
                
                // Get active containers count
                const containersQuery = query(
                    collection(db, "containerOrders"), 
                    where("clientId", "==", clientState.id),
                    where("status", "in", ["new", "processing", "shipped"])
                );
                
                getDocs(containersQuery).then(snapshot => {
                    dom.activeContainers.textContent = snapshot.size;
                });
                
                // Get pending orders count
                const ordersQuery = query(
                    collection(db, "clientOrders"), 
                    where("clientId", "==", clientState.id),
                    where("status", "in", ["new", "processing"])
                );
                
                getDocs(ordersQuery).then(snapshot => {
                    dom.pendingOrders.textContent = snapshot.size;
                });
            }

            // --- UTILITY FUNCTIONS ---
            async function sendClientRequest(requestType, orderId) {
                 try {
                    showToast("שולח בקשה...", '💬');
                    await addDoc(collection(db, "clientRequests"), {
                        clientId: clientState.id,
                        clientName: clientState.name,
                        requestType: requestType,
                        orderId: orderId,
                        timestamp: serverTimestamp(),
                        status: 'new'
                    });
                    showToast("בקשתך נשלחה בהצלחה!", '✅');
                } catch (error) { 
                    showToast(`שגיאה בשליחת הבקשה`, '❌'); 
                }
            }

            function showToast(message, icon = 'ℹ️') {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<span>${icon}</span> ${message}`;
                dom.toastContainer.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => { 
                    toast.classList.remove('show'); 
                    setTimeout(() => toast.remove(), 400); 
                }, 4000);
            }

            function getStatusClass(status) {
                const statusMap = {
                    'חדש': 'new',
                    'בעיבוד': 'processing',
                    'במשלוח': 'shipped',
                    'נמסר': 'delivered',
                    'בוטל': 'cancelled',
                    'סגור': 'cancelled'
                };
                return statusMap[status] || 'new';
            }

            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('he-IL');
            }

            function setupEventListeners() {
                // Navigation buttons
                dom.navButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        dom.navButtons.forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        
                        // Handle navigation
                        if (page === 'page-home') {
                            // Already on home page
                        } else if (page === 'page-materials') {
                            window.location.href = `./Materials.html?customerId=${clientState.id}`;
                        } else if (page === 'page-history') {
                            window.location.href = `./history.html?customerId=${clientState.id}`;
                        }
                    });
                });
                
                // Order action buttons
                document.addEventListener('click', (e) => {
                    if (e.target.matches('[data-action="request-swap"]')) {
                        const orderId = e.target.dataset.id;
                        sendClientRequest('swap', orderId);
                    } else if (e.target.matches('[data-action="request-pickup"]')) {
                        const orderId = e.target.dataset.id;
                        sendClientRequest('pickup', orderId);
                    }
                });
            }

            // Initialize the application
            initApp();
        });
    </script>
</body>
</html>
